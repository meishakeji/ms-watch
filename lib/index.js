!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.meisha_watch=e():t.meisha_watch=e()}(self,(function(){return(()=>{"use strict";var t={408:(t,e,r)=>{r.r(e);var o={};r.r(o);var i={};r.r(i);var s={};r.r(s);var n={};r.r(n);var a={};r.r(a);var c={};r.r(c);var h={};r.r(h);var l={};r.r(l);var d={};r.r(d),/^(127.0.0.1|localhost|192.168)/.test(window.location.host),/^(127.0.0.1|localhost|192.168|nathan-|dev-|hank-|kerry-|39.108.58.1)/.test(window.location.host),/^test-/.test(window.location.host),/^pre-/.test(window.location.host);const u="function"==typeof atob,f="function"==typeof btoa,p="function"==typeof Buffer,g="function"==typeof TextDecoder?new TextDecoder:void 0,m="function"==typeof TextEncoder?new TextEncoder:void 0,w=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),y=(t=>{let e={};return t.forEach(((t,r)=>e[t]=r)),e})(w),x=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,L=String.fromCharCode.bind(String),b="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):(t,e=(t=>t))=>new Uint8Array(Array.prototype.slice.call(t,0).map(e)),v=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),A=f?t=>btoa(t):p?t=>Buffer.from(t,"binary").toString("base64"):t=>{let e,r,o,i,s="";const n=t.length%3;for(let n=0;n<t.length;){if((r=t.charCodeAt(n++))>255||(o=t.charCodeAt(n++))>255||(i=t.charCodeAt(n++))>255)throw new TypeError("invalid character found");e=r<<16|o<<8|i,s+=w[e>>18&63]+w[e>>12&63]+w[e>>6&63]+w[63&e]}return n?s.slice(0,n-3)+"===".substring(n):s},E=p?t=>Buffer.from(t).toString("base64"):t=>{let e=[];for(let r=0,o=t.length;r<o;r+=4096)e.push(L.apply(null,t.subarray(r,r+4096)));return A(e.join(""))},S=t=>{if(t.length<2)return(e=t.charCodeAt(0))<128?t:e<2048?L(192|e>>>6)+L(128|63&e):L(224|e>>>12&15)+L(128|e>>>6&63)+L(128|63&e);var e=65536+1024*(t.charCodeAt(0)-55296)+(t.charCodeAt(1)-56320);return L(240|e>>>18&7)+L(128|e>>>12&63)+L(128|e>>>6&63)+L(128|63&e)},T=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,C=p?t=>Buffer.from(t,"utf8").toString("base64"):m?t=>E(m.encode(t)):t=>A(t.replace(T,S)),M=(t,e=!1)=>e?(t=>t.replace(/=/g,"").replace(/[+\/]/g,(t=>"+"==t?"-":"_")))(C(t)):C(t),D=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,I=t=>{switch(t.length){case 4:var e=((7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3))-65536;return L(55296+(e>>>10))+L(56320+(1023&e));case 3:return L((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return L((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},N=u?t=>atob(v(t)):p?t=>Buffer.from(t,"base64").toString("binary"):t=>{if(t=t.replace(/\s+/g,""),!x.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(3&t.length));let e,r,o,i="";for(let s=0;s<t.length;)e=y[t.charAt(s++)]<<18|y[t.charAt(s++)]<<12|(r=y[t.charAt(s++)])<<6|(o=y[t.charAt(s++)]),i+=64===r?L(e>>16&255):64===o?L(e>>16&255,e>>8&255):L(e>>16&255,e>>8&255,255&e);return i},F=p?t=>b(Buffer.from(t,"base64")):t=>b(N(t),(t=>t.charCodeAt(0))),j=p?t=>Buffer.from(t,"base64").toString("utf8"):g?t=>g.decode(F(t)):t=>N(t).replace(D,I),B=t=>j(v(t.replace(/[-_]/g,(t=>"-"==t?"+":"/"))));(t=r.hmd(t)).exports={MsWatch:class{constructor(t){try{(0,n.initLog)();const{projectName:e,url:r,router:o,reportTime:i,errorMaxNum:s,actionMaxNum:c}=t||{};if(this.reportTime=i||n.reportSplitTime,this.errorMaxNum=s||n.errorNum,this.actionMaxNum=c||n.actionNum,this.error=new a.MSError,this.listenLoad(),this.listenUnload(),this.listenVisible(),this.timing=null,this.device=null,this.mconsole=null,this.action=null,this.storage=null,this.useInfo=null,this.timeId=(0,d.guid)(),window.encode=M,window.decode=B,!e)throw new Error("projectName 不能为空");if(!r)throw new Error("URL 不能为空");if(!o)throw new Error("请传入router实例");this.projectName=e,this.url=r,this.router=o,this.firstEnter=!0,this.lastTime=0,this.requestId=(0,d.guid)(0,24,!1),this.pending=!1}catch(t){console.error(t)}}async init(){const t=window.performance||window.msPerformance||window.webkitPerformance;let e=localStorage.getItem("userInfo");e&&(e=JSON.parse(e),this.userInfo=e),this.timing=new o.MSTiming(t),this.device=new i.MSDevice,this.mconsole=new s.MSConsole,this.action=new c.MSUserAction(this.router,e),this.storage=new l.MSStorage(e);const r=await this.timing.getTime();let a={};for(let{key:t,value:e}of n.TimeLog)a[e]=`${r[t]}ms`;this.mconsole.log(a),this.action.listenRouter(),this.action.listenAction(this.actionReport.bind(this)),this.mconsole.warn(),this.mconsole.error(),this.error.recordError(this.errorReport.bind(this)),this.msend=new h.MSSendData({url:this.url,method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"}}),this.report()}getData(){const t=this.timing&&this.timing.getTime(),e=this.device&&this.device.getInfo(),r=this.mconsole&&this.mconsole.getInfo(),o=this.action&&this.action.getInfo();o.userInfo={};const{userId:i,name:s,realname:n,phoneNo:a}=this.userInfo||{};r.typeError=this.error.errorList;let c={console:r,action:o};this.firstEnter&&(c=(this.storage&&this.storage.get("MsError"))[0]||{});const h={project:this.projectName,requestId:this.requestId,httpHost:window.location.host,requestUri:encodeURIComponent(window.location.href),user:{userId:i,name:s||n,phoneNo:a},timing:t,device:e,logs:[c]},l=c.console;let d=0;return l&&(l.errorList&&l.errorList.length>0||l.typeError&&l.typeError.length>0?d=1:l.warnList&&l.warnList.length>0&&(d=2)),h.dataStatus=d,h}getLogs(){return{console:this.mconsole.getInfo(),action:this.action.getInfo(),typeError:this.error.errorList}}clearData(){this.mconsole.clearInfo(),this.action.clearInfo(),this.firstEnter=!1,this.error.errorList=[]}listenLoad(){this.error.handleAddListener("load",(()=>{setTimeout((async()=>{this.init()}),200)}))}listenUnload(){let t=this;this.error.handleAddListener("beforeunload",(()=>{t.saveLog()}))}listenVisible(){let t=this;this.error.handleAddListener("visibilitychange",(e=>{"visible"===document.visibilityState&&setTimeout((()=>{t.saveLog()}),200)}))}saveLog(){try{const t=this.getData(),e=this.storage&&this.storage.get("MsError")||[];if(e.length>0&&e[0].console&&e[0].action){const r=t.logs.console,o=t.logs.action,i=e[0].console,s=e[0].action,n=r&&r.errorList||[];i.errorList&&n.push(...i.errorList);const a=r&&r.typeError||[];i.typeError&&a.push(...i.typeError);const c=r&&r.warnList||[];i.warnList&&c.push(...i.warnList);const h=o&&o.clickList||[];s.clickList&&h.push(...s.clickList);const l=o&&o.routeList||[];s.routeList&&l.push(...s.routeList)}return this.storage.set("MsError",t.logs),t}catch(t){return console.error(t),!1}}clearLog(){this.storage.set("MsError",[])}encodeData(t){const e=JSON.stringify(t);return M(e)}async report(){const t=this.saveLog();this.firstEnter&&this.reportData(t)}errorReport(){const t=this.error.errorList,e=this.saveLog(),r=Date.now()-this.lastTime>this.reportTime,o=t.length>=this.errorMaxNum;r&&o&&this.reportData(e)}actionReport(){const t=this.action.clickList,e=this.action.routeList,r=this.saveLog(),o=Date.now()-this.lastTime>this.reportTime,i=t.length>=this.actionMaxNum||e.length>=this.actionMaxNum;o&&i&&this.reportData(r)}async reportData(t){if(this.pending)return!1;try{this.pending=!0,await this.msend.xhrReport(this.encodeData(t)),this.clearData(),this.clearLog(),this.lastTime=Date.now(),this.pending=!1}catch(t){throw t}}}}}},e={};function r(o){var i=e[o];if(void 0!==i)return i.exports;var s=e[o]={id:o,loaded:!1,exports:{}};return t[o](s,s.exports,r),s.loaded=!0,s.exports}return r.hmd=t=>((t=Object.create(t)).children||(t.children=[]),Object.defineProperty(t,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+t.id)}}),t),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r(408)})()}));
//# sourceMappingURL=index.js.map